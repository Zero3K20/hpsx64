
# MakefilePS1_Linux.txt - Linux/Steam Deck build for hps1x64 (PS1 emulator)
# Usage: make -f MakefilePS1_Linux.txt
#
# Requirements (install on Steam Deck/Arch Linux):
#   sudo pacman -S gcc make libsdl2 libsdl2-devel mesa mesa-libgl libgl
#   or: sudo apt-get install g++ make libsdl2-dev libgl1-mesa-dev

DIR_COMMON = ./common
DIR_LINUX_API = $(DIR_COMMON)/LinuxAPI
DIR_PLATFORM = $(DIR_COMMON)/WindowsAPI
DIR_HPS1X64 = ./hps1x64/src

# Linux API include dirs (these override Windows versions - MUST come first)
INC_LINUX_COMPAT = -include $(DIR_LINUX_API)/windows_compat.h
INC_LINUX_API = -I$(DIR_LINUX_API) \
                -I$(DIR_LINUX_API)/GUIHandler/src -I$(DIR_LINUX_API)/WinFile/src \
                -I$(DIR_LINUX_API)/gui -I$(DIR_LINUX_API)/gamepad \
                -I$(DIR_LINUX_API)/padconfig -I$(DIR_LINUX_API)/capture_console \
                -I$(DIR_LINUX_API)/recompile -I$(DIR_LINUX_API)/audio

# Windows platform dirs (for debug viewer headers that still work with our Linux WinApiHandler)
INC_PLATFORM = -I$(DIR_HPS1X64)/hps1x64/src/ \
               -I$(DIR_PLATFORM)/GUIHandler/src/ \
               -I$(DIR_PLATFORM)/WinFile/src/ \
               -I$(DIR_PLATFORM)/DebugValueList/src/ \
               -I$(DIR_PLATFORM)/DisassemblyViewer/src/ \
               -I$(DIR_PLATFORM)/InputBox/src/ \
               -I$(DIR_PLATFORM)/DebugMemoryViewer/src/ \
               -I$(DIR_PLATFORM)/BreakpointWindow/src/ \
               -I$(DIR_PLATFORM)/Joystick/src/

DIR_YAML = ./common/yaml/src/yaml-cpp
INC_YAML = -I$(DIR_YAML)

INC_COMMON = -I$(DIR_COMMON) \
             -I$(DIR_COMMON)/breakpoint/src \
             -I$(DIR_COMMON)/debug/src \
             -I$(DIR_COMMON)/DiskImage/cd/src \
             -I$(DIR_COMMON)/DiskImage/libchd/libchdr \
             -I$(DIR_COMMON)/DiskImage/libchd/lzma-19.00/src \
             -I$(DIR_COMMON)/DiskImage/libchd/zlib-1.2.13 \
             -I$(DIR_COMMON)/StringUtilities \
             -I$(DIR_COMMON)/Vulkan \
             -I$(DIR_COMMON)/x64Encoder/src \
             -I$(DIR_COMMON)/x64Assembler

DIR_PS1 = $(DIR_HPS1X64)
DIR_PS1_R3000A = $(DIR_PS1)/r3000a/src
DIR_PS1_CD = $(DIR_PS1)/cd/src
DIR_PS1_GPU = $(DIR_PS1)/gpu/src
DIR_PS1_DMA = $(DIR_PS1)/dma/src
DIR_PS1_INTC = $(DIR_PS1)/intc/src
DIR_PS1_MDEC = $(DIR_PS1)/mdec/src
DIR_PS1_SPU = $(DIR_PS1)/spu/src
DIR_PS1_SIO = $(DIR_PS1)/sio/src
DIR_PS1_PIO = $(DIR_PS1)/pio/src
DIR_PS1_TIMER = $(DIR_PS1)/timer/src
DIR_PS1_BUS = $(DIR_PS1)/databus/src
DIR_PS1_SYSTEM = $(DIR_PS1)/system/src

INC_PS1_R3000A = -I$(DIR_PS1_R3000A) -I$(DIR_PS1_R3000A)/execute \
                 -I$(DIR_PS1_R3000A)/lookup -I$(DIR_PS1_R3000A)/print \
                 -I$(DIR_PS1_R3000A)/COP2 -I$(DIR_PS1_R3000A)/recompile \
                 -I$(DIR_PS1_R3000A)/cache
INC_PS1_CD = -I$(DIR_PS1_CD)
INC_PS1_GPU = -I$(DIR_PS1_GPU)
INC_PS1_DMA = -I$(DIR_PS1_DMA)
INC_PS1_INTC = -I$(DIR_PS1_INTC)
INC_PS1_MDEC = -I$(DIR_PS1_MDEC)
INC_PS1_SPU = -I$(DIR_PS1_SPU)
INC_PS1_SIO = -I$(DIR_PS1_SIO)
INC_PS1_PIO = -I$(DIR_PS1_PIO)
INC_PS1_TIMER = -I$(DIR_PS1_TIMER)
INC_PS1_BUS = -I$(DIR_PS1_BUS)
INC_PS1_SYSTEM = -I$(DIR_PS1_SYSTEM)
INC_PS1 = $(INC_PS1_R3000A) $(INC_PS1_CD) $(INC_PS1_GPU) $(INC_PS1_DMA) \
          $(INC_PS1_INTC) $(INC_PS1_MDEC) $(INC_PS1_SPU) $(INC_PS1_SIO) \
          $(INC_PS1_PIO) $(INC_PS1_TIMER) $(INC_PS1_BUS) $(INC_PS1_SYSTEM)

# Source files - Linux API replaces Windows-specific platform code
SRC_LINUX_PLATFORM = $(wildcard $(DIR_HPS1X64)/hps1x64/src/*.cpp) \
                     $(wildcard $(DIR_LINUX_API)/GUIHandler/src/*.cpp) \
                     $(wildcard $(DIR_LINUX_API)/WinFile/src/*.cpp) \
                     $(wildcard $(DIR_LINUX_API)/capture_console/*.cpp) \
                     $(wildcard $(DIR_LINUX_API)/gamepad/*.cpp) \
                     $(wildcard $(DIR_LINUX_API)/gui/*.cpp) \
                     $(wildcard $(DIR_LINUX_API)/recompile/*.cpp) \
                     $(DIR_LINUX_API)/linux_main.cpp \
                     $(DIR_LINUX_API)/memmgmt.cpp \
                     $(wildcard $(DIR_PLATFORM)/DisassemblyViewer/src/*.cpp) \
                     $(wildcard $(DIR_PLATFORM)/BreakpointWindow/src/*.cpp) \
                     $(wildcard $(DIR_PLATFORM)/DebugMemoryViewer/src/*.cpp) \
                     $(wildcard $(DIR_PLATFORM)/DebugValueList/src/*.cpp) \
                     $(wildcard $(DIR_PLATFORM)/InputBox/src/*.cpp) \
                     $(DIR_COMMON)/x64Assembler/x64_assembler.cpp

DIR_LIBCHD = $(DIR_COMMON)/DiskImage/libchd
DIR_LIBCHDR = $(DIR_LIBCHD)/libchdr
DIR_LZMA = $(DIR_LIBCHD)/lzma-19.00/src
DIR_ZLIB = $(DIR_LIBCHD)/zlib-1.2.13

SRC_COMMON = $(wildcard $(DIR_COMMON)/StringUtilities/*.cpp) \
             $(wildcard $(DIR_COMMON)/breakpoint/src/*.cpp) \
             $(wildcard $(DIR_COMMON)/debug/src/*.cpp) \
             $(wildcard $(DIR_COMMON)/DiskImage/cd/src/*.cpp) \
             $(wildcard $(DIR_COMMON)/x64Encoder/src/*.cpp) \
             $(wildcard $(DIR_COMMON)/config/src/*.cpp)

# C files from third-party libraries must be compiled with gcc (not g++)
# to avoid conflicts with windows_compat.h and K&R C syntax
SRC_C = $(wildcard $(DIR_LIBCHDR)/*.c) \
        $(wildcard $(DIR_LZMA)/*.c) \
        $(wildcard $(DIR_ZLIB)/*.c)
OBJ_C = $(patsubst %.c,%.o,$(SRC_C))
INC_LIBCHD = -I$(DIR_LIBCHDR) -I$(DIR_LZMA) -I$(DIR_ZLIB)

SRC_PS1_R3000A = $(wildcard $(DIR_PS1_R3000A)/*.cpp) \
                 $(wildcard $(DIR_PS1_R3000A)/execute/*.cpp) \
                 $(wildcard $(DIR_PS1_R3000A)/lookup/*.cpp) \
                 $(wildcard $(DIR_PS1_R3000A)/print/*.cpp) \
                 $(wildcard $(DIR_PS1_R3000A)/COP2/*.cpp) \
                 $(wildcard $(DIR_PS1_R3000A)/recompile/*.cpp)
SRC_PS1_CD = $(wildcard $(DIR_PS1_CD)/*.cpp)
SRC_PS1_GPU = $(wildcard $(DIR_PS1_GPU)/*.cpp)
SRC_PS1_DMA = $(wildcard $(DIR_PS1_DMA)/*.cpp)
SRC_PS1_INTC = $(wildcard $(DIR_PS1_INTC)/*.cpp)
SRC_PS1_MDEC = $(wildcard $(DIR_PS1_MDEC)/*.cpp)
SRC_PS1_SPU = $(wildcard $(DIR_PS1_SPU)/*.cpp)
SRC_PS1_SIO = $(wildcard $(DIR_PS1_SIO)/*.cpp)
SRC_PS1_PIO = $(wildcard $(DIR_PS1_PIO)/*.cpp)
SRC_PS1_TIMER = $(wildcard $(DIR_PS1_TIMER)/*.cpp)
SRC_PS1_BUS = $(wildcard $(DIR_PS1_BUS)/*.cpp)
SRC_PS1_SYSTEM = $(wildcard $(DIR_PS1_SYSTEM)/*.cpp)
SRC_PS1 = $(SRC_PS1_R3000A) $(SRC_PS1_CD) $(SRC_PS1_GPU) $(SRC_PS1_DMA) \
          $(SRC_PS1_INTC) $(SRC_PS1_MDEC) $(SRC_PS1_SPU) $(SRC_PS1_SIO) \
          $(SRC_PS1_PIO) $(SRC_PS1_TIMER) $(SRC_PS1_BUS) $(SRC_PS1_SYSTEM)

# SDL2 flags
SDL2_CFLAGS := $(shell sdl2-config --cflags 2>/dev/null || echo "-I/usr/include/SDL2 -D_REENTRANT")
SDL2_LIBS := $(shell sdl2-config --libs 2>/dev/null || echo "-lSDL2")

INC = $(INC_LINUX_COMPAT) $(INC_LINUX_API) $(INC_PS1) $(INC_COMMON) $(INC_PLATFORM) $(INC_YAML) $(SDL2_CFLAGS)
SRC = $(SRC_PS1) $(SRC_COMMON) $(SRC_LINUX_PLATFORM)

LIBS = $(SDL2_LIBS) -lGL -lGLU -lpthread -ldl
CFLAGS = -w -std=c++17 -fpermissive -ftemplate-depth=2048 -msse4.2 \
         -O3 -DUSE_PS1_GPU_TEMPLATES -DDISABLE_RECOMPILER_R3000A \
         -DLINUX_BUILD

OBJ = hps1x64_linux

$(OBJ): $(SRC) $(OBJ_C)
	g++ $(CFLAGS) $(INC) -o $@ $(SRC) $(OBJ_C) $(LIBS)

$(OBJ_C): %.o: %.c
	gcc -w -O3 $(INC_LIBCHD) -D_open=open -D_read=read -D_write=write -D_close=close -c -o $@ $<

clean:
	rm -f $(OBJ) $(OBJ_C)
